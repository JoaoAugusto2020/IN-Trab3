<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recomendação de Alimentos</title>
    <link rel="icon" type="image/x-icon" href="imgs/comida-saudavel.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Recomendação de Alimentos</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="analise.html">Análise do Knime</a></li>
                    <li class="nav-item"><a class="nav-link" href="sobre.html">Sobre</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5 mb-5">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h1 class="h4 mb-0">Seu Alimento</h1>
                    </div>
                    <div class="card-body">
                        <form id="nutricionalForm">
                            <h1 class="mb-3 h5">Insira os valores nutricionais:</h1>
                            <div class="mb-3">
                                <label for="nomeProduto" class="form-label">Nome do Produto (Opcional)</label>
                                <input type="text" class="form-control" id="nomeProduto" placeholder="Ex: Cows' milk" value="Cows' milk">
                            </div>
                            <div class="mb-3">
                                <label for="gramasAmostra" class="form-label">Gramas da Amostra (g)</label>
                                <input type="number" step="0.001" class="form-control" id="gramasAmostra" placeholder="Insira entre 1,419 e 984" min="1.419" max="984" required value="976">
                            </div>
                            <div class="mb-3">
                                <label for="proteinas" class="form-label">Proteínas (g)</label>
                                <input type="number" step="0.01" class="form-control" id="proteinas" placeholder="Insira entre 0 e 232" min="0" max="232" required value="32">
                            </div>
                            <div class="mb-3">
                                <label for="fibras" class="form-label">Fibras (g)</label>
                                <input type="number" step="0.01" class="form-control" id="fibras" placeholder="Insira entre 0 e 235" min="0" max="235" required value="0">
                            </div>
                            <div class="mb-3">
                                <label for="carboidratos" class="form-label">Carboidratos (g)</label>
                                <input type="number" step="0.01" class="form-control" id="carboidratos" placeholder="Insira entre 0 e 236" min="0" max="236" required value="48">
                            </div>
                            <div class="mb-3">
                                <label for="calorias" class="form-label">Calorias (kcal)</label>
                                <input type="number" step="0.01" class="form-control" id="calorias" placeholder="Insira entre 0 e 992" min="0" max="992" required value="660">
                            </div>
                            <hr>
                            <button type="submit" class="btn btn-success">Buscar Alimento Semelhante</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card" id="resultado-card">
                    <div class="card-header bg-success text-white">
                        <h1 class="h4 mb-0">Produto Recomendado</h1>
                    </div>
                    <div class="card-body">
                        <div id="resultado-placeholder" class="placeholder-container">
                            <p class="text-muted text-center">Processe os dados para visualizar a recomendação.</p>
                        </div>
                        <form id="resultadoForm" style="display: none;">
                            <h1 class="mb-3 h5">Este é o alimento mais próximo que encontramos:</h1>
                            <div class="mb-3">
                                <label for="resultadoNomeProduto" class="form-label">Nome do Produto</label>
                                <input type="text" class="form-control" id="resultadoNomeProduto" disabled>
                            </div>
                            <div class="mb-3">
                                <label for="resultadoGramas" class="form-label">Gramas da Amostra (g)</label>
                                <input type="text" class="form-control" id="resultadoGramas" disabled>
                            </div>
                            <div class="mb-3">
                                <label for="resultadoProteinas" class="form-label">Proteínas (g)</label>
                                <input type="text" class="form-control" id="resultadoProteinas" disabled>
                            </div>
                            <div class="mb-3">
                                <label for="resultadoFibras" class="form-label">Fibras (g)</label>
                                <input type="text" class="form-control" id="resultadoFibras" disabled>
                            </div>
                            <div class="mb-3">
                                <label for="resultadoCarboidratos" class="form-label">Carboidratos (g)</label>
                                <input type="text" class="form-control" id="resultadoCarboidratos" disabled>
                            </div>
                            <div class="mb-3">
                                <label for="resultadoCalorias" class="form-label">Calorias (kcal)</label>
                                <input type="text" class="form-control" id="resultadoCalorias" disabled>
                            </div>
                            <div class="mb-3">
                                <label for="resultadoDistancia" class="form-label">Distância Euclidiana</label>
                                <input type="text" class="form-control" id="resultadoDistancia" disabled>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container mt-5 mb-5" id="detalhes-analise">
        <div class="card">
            <div class="card-header">
                <h2 class="h5 mb-0">Detalhes da Análise</h2>
            </div>
            <div class="card-body">
                <div id="detalhes-placeholder">
                    <p class="text-muted text-center p-4">Processe os dados para visualizar os detalhes da análise.</p>
                </div>
                <div class="row" id="detalhes-results-row" style="display: none;">
                    <div class="col-md-6" id="dadosNormalizados"></div>
                    <div class="col-md-6" id="clusterVencedor"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        $(document).ready(function() {
            const limites = {
                gramas:       { min: 1.419, max: 984 },
                proteinas:    { min: 0,     max: 232 },
                fibras:       { min: 0,     max: 235 },
                carboidratos: { min: 0,     max: 236 },
                calorias:     { min: 0,     max: 992 }
            };

            function normalize(val, min, max) {
                if (max === min) return 0;
                return (val - min) / (max - min);
            }

            function denormalize(val, min, max) {
                return val * (max - min) + min;
            }

            function getDistanciaCluster0(produto) {
                let difPro = produto.valPro - 0.025237381309345414;
                let difCar = produto.valCar - 0.055639482518627686;
                let difGra = produto.valGra - 0.10863475321062023;
                let difFib = produto.valFib - 0.0030611573645801223;
                let difCal = produto.valCal - 0.09143862494156146;
                return Math.pow(difPro, 2) + Math.pow(difCar, 2) + Math.pow(difGra, 2) + Math.pow(difFib, 2) + Math.pow(difCal, 2);
            }

            function getDistanciaCluster1(produto) {
                let difPro = produto.valPro - 0.044540229885057514;
                let difCar = produto.valCar - 0.12868801004394226;
                let difGra = produto.valGra - 0.16796982942165878;
                let difFib = produto.valFib - 0.0038691883372734435;
                let difCal = produto.valCal - 0.30252202807646356;
                return Math.pow(difPro, 2) + Math.pow(difCar, 2) + Math.pow(difGra, 2) + Math.pow(difFib, 2) + Math.pow(difCal, 2);
            }
            
            function getDistanciaCluster2(produto) {
                let difPro = produto.valPro - 0.16738505747126436;
                let difCar = produto.valCar - 0.5969868173258003;
                let difGra = produto.valGra - 0.33955119787127525;
                let difFib = produto.valFib - 0.13118203309692672;
                let difCal = produto.valCal - 0.4551033266129032;
                return Math.pow(difPro, 2) + Math.pow(difCar, 2) + Math.pow(difGra, 2) + Math.pow(difFib, 2) + Math.pow(difCal, 2);
            }
            
            function getCluster(produto) {
                let distancias = {
                    cluster_0: getDistanciaCluster0(produto),
                    cluster_1: getDistanciaCluster1(produto),
                    cluster_2: getDistanciaCluster2(produto)
                }

                let menorDistancia = Infinity;
                let clusterVencedor = '';
                for(const cluster in distancias) {
                    if (distancias[cluster] < menorDistancia) {
                        menorDistancia = distancias[cluster];
                        clusterVencedor = cluster;
                    }
                }
                return clusterVencedor;
            }

            function getDescricaoCluster(cluster){
                txt = ""
                if(cluster == "cluster_0"){
                    txt = "Produto com valor baixo em calorias (kcal), valor baixo-médio em carboidratos e valor baixo no peso/amostra."
                }else if(cluster == "cluster_1"){
                    txt = "Produto com valor alto-médio em calorias (kcal) e valor baixo em fibras."
                }else if(cluster == "cluster_2"){
                    txt = "Produto com valor alto em fibras, valor alto em carboidratos e valor alto-médio em proteínas."
                }
                return txt
            }

            async function recomendarProduto(produto) {
                const arquivoCSV = "knime/k-means_normalizado.csv";

                try {
                    resposta = await fetch(arquivoCSV);
                    if (!resposta.ok) throw new Error(`Erro de rede: ${resposta.statusText}`);
                    textoCSV = await resposta.text();

                    return new Promise((resolve, reject) => {
                        Papa.parse(textoCSV, {
                            header: true,
                            skipEmptyLines: true,
                            dynamicTyping: true,
                            complete: function(resultados) {

                                //filtro de cluster
                                const clusterAlvo = getCluster(produto);
                                const dadosFiltrados = resultados.data.filter(linha => linha['Cluster'] === clusterAlvo);
                                
                                //dados para busca semelhante
                                const colunasCSV = ['Proteina', 'Carboidratos', 'Gramas', 'Fibras', 'Calorias'];
                                const produtoAlvo = {
                                    Nome: produto.nome,
                                    Proteina: produto.valPro,
                                    Carboidratos: produto.valCar,
                                    Gramas: produto.valGra,
                                    Fibras: produto.valFib,
                                    Calorias: produto.valCal
                                };
                                
                                //menor distância entre os produtos
                                let menorDistancia = Infinity;
                                let produtoMaisProximo = null;
                                for (const produtoAtual of dadosFiltrados) {
                                    if (produtoAtual.Produto === produtoAlvo.Nome) continue; //pular o próprio produto

                                    //soma das diferenças
                                    let somaDosQuadrados = 0;
                                    for (const coluna of colunasCSV) {
                                        diferenca = produtoAlvo[coluna] - produtoAtual[coluna];
                                        somaDosQuadrados += Math.pow(diferenca, 2);
                                    }

                                    //menor distância
                                    let distancia = Math.sqrt(somaDosQuadrados);
                                    if (distancia < menorDistancia) {
                                        menorDistancia = distancia;
                                        produtoMaisProximo = produtoAtual;
                                        produtoMaisProximo.distancia = menorDistancia;
                                    }
                                }
                                
                                resolve(produtoMaisProximo);
                            },
                            error: (err) => reject(err)
                        });
                    });
                } catch (error) {
                    alert('Falha na operação:', error);
                    return null;
                }
            }
            
            $('#nutricionalForm').on('submit', async function(event) {
                event.preventDefault();
                
                $('#resultado-placeholder').hide();
                $('#resultadoForm').show();
                $('#detalhes-placeholder').hide();
                $('#detalhes-results-row').show();

                $('#dadosNormalizados, #clusterVencedor').empty();

                var nomeProduto = $('#nomeProduto').val();
                var gramas = parseFloat($('#gramasAmostra').val());
                var proteinas = parseFloat($('#proteinas').val());
                var fibras = parseFloat($('#fibras').val());
                var carboidratos = parseFloat($('#carboidratos').val());
                var calorias = parseFloat($('#calorias').val());
                
                if (isNaN(gramas) || isNaN(proteinas) || isNaN(fibras) || isNaN(carboidratos) || isNaN(calorias)) {
                    $('#resultadoForm').hide();
                    $('#resultado-placeholder').show().find('p').text('Erro: Preencha todos os campos com valores válidos.');
                    $('#detalhes-results-row').hide();
                    $('#detalhes-placeholder').show().find('p').text('Processamento falhou devido a erro nos dados de entrada.');
                    return;
                }

                var normGramas = normalize(gramas, limites.gramas.min, limites.gramas.max);
                var normProteinas = normalize(proteinas, limites.proteinas.min, limites.proteinas.max);
                var normFibras = normalize(fibras, limites.fibras.min, limites.fibras.max);
                var normCarboidratos = normalize(carboidratos, limites.carboidratos.min, limites.carboidratos.max);
                var normCalorias = normalize(calorias, limites.calorias.min, limites.calorias.max);

                var produto = {
                    nome: nomeProduto,
                    valPro: normProteinas,
                    valCar: normCarboidratos,
                    valGra: normGramas,
                    valFib: normFibras,
                    valCal: normCalorias
                };

                const htmlResultadoNormalize = `
                    <div class="alert alert-secondary">
                        <h4 class="alert-heading h6">Dados Normalizados (Entrada)</h4>
                        <ul class="list-unstyled mb-0 small">
                            <li><strong>Gramas:</strong> ${normGramas.toFixed(4)}</li>
                            <li><strong>Proteínas:</strong> ${normProteinas.toFixed(4)}</li>
                            <li><strong>Fibras:</strong> ${normFibras.toFixed(4)}</li>
                            <li><strong>Carboidratos:</strong> ${normCarboidratos.toFixed(4)}</li>
                            <li><strong>Calorias:</strong> ${normCalorias.toFixed(4)}</li>
                        </ul>
                    </div>`;
                $('#dadosNormalizados').html(htmlResultadoNormalize);

                const htmlResultadoCluster = `
                    <div class="alert alert-secondary">
                        <h4 class="alert-heading h6">Cluster Vencedor</h4>
                        <ul class="list-unstyled mb-0 small">
                            <li><strong>Seu alimento pertence ao:</strong> ${getCluster(produto)}</li>
                            <li><strong>Descrição do cluster:</strong> ${getDescricaoCluster(getCluster(produto))}</li>
                        </ul>
                    </div>`;
                $('#clusterVencedor').html(htmlResultadoCluster);
                
                const produtoSemelhante = await recomendarProduto(produto);
                if (produtoSemelhante) {
                    var originalGramas = denormalize(produtoSemelhante.Gramas, limites.gramas.min, limites.gramas.max);
                    var originalProteina = denormalize(produtoSemelhante.Proteina, limites.proteinas.min, limites.proteinas.max);
                    var originalFibras = denormalize(produtoSemelhante.Fibras, limites.fibras.min, limites.fibras.max);
                    var originalCarboidratos = denormalize(produtoSemelhante.Carboidratos, limites.carboidratos.min, limites.carboidratos.max);
                    var originalCalorias = denormalize(produtoSemelhante.Calorias, limites.calorias.min, limites.calorias.max);

                    $('#resultadoNomeProduto').val(produtoSemelhante.Produto);
                    $('#resultadoGramas').val(originalGramas.toFixed(1));
                    $('#resultadoProteinas').val(originalProteina.toFixed(1));
                    $('#resultadoFibras').val(originalFibras.toFixed(1));
                    $('#resultadoCarboidratos').val(originalCarboidratos.toFixed(1));
                    $('#resultadoCalorias').val(originalCalorias.toFixed(1));
                    $('#resultadoDistancia').val(produtoSemelhante.distancia.toFixed(4));

                } else {
                    $('#resultadoForm').hide();
                    $('#resultado-placeholder').show().find('p').text('Não foi possível encontrar um produto semelhante com os dados fornecidos.');
                }
            });
        });
    </script>

</body>
</html>